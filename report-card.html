
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Report Generator - Rama Exam System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <h2>Generate Report Card</h2>
  <button onclick="initDB()">Load DB</button>
  <br><br>
  <label>Assessment Number: <input id="admInput" /></label>
  <label>Exam Type: 
    <select id="examType">
      <option>Mid Term</option>
      <option>End Term</option>
    </select>
  </label>
  <button onclick="generateReport()">Generate</button>

  <pre id="reportDisplay" style="margin-top:20px; white-space: pre-wrap;"></pre>

  <script>
    let db;

    async function initDB() {
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
      db = new SQL.Database();
      alert("DB loaded! Ensure students and marks are entered.");
    }

    function generateReport() {
      const adm = document.getElementById('admInput').value;
      const exam = document.getElementById('examType').value;
      const marksQuery = `SELECT subject, marks FROM marks WHERE assessment_no='${adm}' AND exam_type='${exam}'`;
      const studentQuery = `SELECT name, gender, grade FROM students WHERE assessment_no='${adm}'`;

      const student = db.exec(studentQuery)[0];
      if (!student) {
        alert("Student not found.");
        return;
      }

      const name = student.values[0][0];
      const gender = student.values[0][1];
      const grade = student.values[0][2];

      const result = db.exec(marksQuery);
      if (!result.length) {
        document.getElementById("reportDisplay").textContent = "No marks found.";
        return;
      }

      const marksList = result[0].values;
      let total = 0;
      let lines = marksList.map(([subj, score]) => {
        total += score;
        return `${subj.padEnd(25)}: ${score}`;
      }).join("\n");

      const avg = (total / marksList.length).toFixed(1);
      const PL = total >= 675 ? "EE" : total >= 450 ? "ME" : total >= 225 ? "AE" : "BE";
      const AL = total >= 675 ? "AL8" : total >= 600 ? "AL7" : total >= 525 ? "AL6" : total >= 450 ? "AL5" :
                 total >= 375 ? "AL4" : total >= 300 ? "AL3" : total >= 225 ? "AL2" : "AL1";

      const report = `--- REPORT CARD ---
Name: ${name}
Assessment No: ${adm}
Gender: ${gender}  Grade: ${grade}
Exam Type: ${exam}

${lines}

-------------------------
Total Marks: ${total}
Average: ${avg}
Performance Level (PL): ${PL}
Achievement Level (AL): ${AL}
-------------------------
Remarks: ${PL === "EE" ? "Excellent work!" : PL === "ME" ? "Good effort." : "Needs improvement."}
`;

      document.getElementById("reportDisplay").textContent = report;
    }
  </script>
</body>
</html>
